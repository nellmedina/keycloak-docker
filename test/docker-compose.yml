version: '2'

services:
  nginx:
    image: blacklabelops/nginx
    container_name: nginx_blacklabel_prod
    ports:
      - '443:443'
      - '80:80'
    volumes:
      - nginx_volume:/home/nginx
      - letsencrypt_certificates:/etc/letsencrypt
      - letsencrypt_challenges:/var/www/letsencrypt
    environment:
      - 'SERVER1SERVER_NAME=${KEYCLOAK_DOMAIN_NAME}'
      - 'SERVER1REVERSE_PROXY_LOCATION1=/auth'
      - 'SERVER1REVERSE_PROXY_PASS1=http://keycloak:8080/'
      - 'SERVER1HTTPS_ENABLED=${KEYCLOAK_HTTPS}'
      - 'SERVER1HTTP_ENABLED=${KEYCLOAK_HTTP}'
      - 'SERVER1LETSENCRYPT_CERTIFICATES=${KEYCLOAK_HTTPS}'
      - 'SERVER1CERTIFICATE_FILE=/etc/letsencrypt/live/${KEYCLOAK_DOMAIN_NAME_PARENT}/fullchain.pem'
      - 'SERVER1CERTIFICATE_KEY=/etc/letsencrypt/live/${KEYCLOAK_DOMAIN_NAME_PARENT}/privkey.pem'
      - 'SERVER1CERTIFICATE_TRUSTED=/etc/letsencrypt/live/${KEYCLOAK_DOMAIN_NAME_PARENT}/fullchain.pem'
      - 'SERVER1PROXY_APPLICATION=keycloak'
  keycloak:
    image: jboss/keycloak
    container_name: keycloak_server
    hostname: keycloak
    restart: unless-stopped
    environment:
      - KEYCLOAK_USER=admin
      - KEYCLOAK_PASSWORD=admin
      - PROXY_ADDRESS_FORWARDING=true
    ports:
      - "8080:8080"

volumes:
  nginx_volume:
    external: true
  letsencrypt_certificates:
    external: true
  letsencrypt_challenges:
    external: true